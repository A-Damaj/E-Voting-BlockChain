<!DOCTYPE html>
<html>
<head>
    <title>Custom Voting Contract</title>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
<script src="./ethers-5.0.esm.min.js"></script>

</head>
<body>
    <h2>Custom Voting Contract</h2>
    <button id="connectButton" onclick="connectMetamask()">Connect to MetaMask</button>
    <p id="metamasknotification"></p>
    <hr>
    <h3>Add Vote</h3>
    <input type="text" id="vote" placeholder="Your vote">
    <button id="addVoteButton" onclick="addVote()">Add Vote</button>
    <p id="cand"></p>
    <hr>
    <h3>Voting Status</h3>
    <button id="voteStatusButton" onclick="voteStatus()">Check Voting Status</button>
    <p id="status"></p>
    <p id="time"></p>
    <hr>
    <h3>All Candidates</h3>
    <button id="getAllCandidatesButton" onclick="getAllCandidates()">Get All Candidates</button>
    <table id="myTable">
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Votes</th>
        </tr>
    </table>
    <p id="p3"></p>
    <script>
        let WALLET_CONNECTED = 0;
        const contractAddress = '0xd9145CCE52D386f254917e481eB44e9943F39138';
        const contractAbi = [
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_name",
				"type": "string"
			}
		],
		"name": "addNewCandidate",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_candidateIndex",
				"type": "uint256"
			}
		],
		"name": "castVote",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string[]",
				"name": "_initialCandidateNames",
				"type": "string[]"
			},
			{
				"internalType": "uint256",
				"name": "_durationInMinutes",
				"type": "uint256"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "candidates",
		"outputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "voteCount",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getAllCandidates",
		"outputs": [
			{
				"internalType": "string[]",
				"name": "",
				"type": "string[]"
			},
			{
				"internalType": "uint256[]",
				"name": "",
				"type": "uint256[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_candidateIndex",
				"type": "uint256"
			}
		],
		"name": "getCandidateVotes",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getRemainingTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getVotingStatus",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "hasVoted",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "NumberOfCandidates",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "votingEnd",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "votingStart",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

        const connectMetamask = async() => {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            const signer = provider.getSigner();
            WALLET_CONNECTED = await signer.getAddress();
            var element = document.getElementById("metamasknotification");
            element.innerHTML = "Metamask is connected " + WALLET_CONNECTED;
        }

        const addVote = async() => {
            if(WALLET_CONNECTED != 0) {
                var name = document.getElementById("vote");
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                const signer = provider.getSigner();
                const contractInstance = new ethers.Contract(contractAddress, contractAbi, signer);
                var cand = document.getElementById("cand");
                cand.innerHTML = "Please wait, adding a vote in the smart contract";
                const tx = await contractInstance.vote(name.value);
                await tx.wait();
                cand.innerHTML = "Vote added !!!";
            }
            else {
                var cand = document.getElementById("cand");
                cand.innerHTML = "Please connect metamask first";
            }
        }

        const voteStatus = async() => {
            if(WALLET_CONNECTED != 0) {
                var status = document.getElementById("status");
                var remainingTime = document.getElementById("time");
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                const signer = provider.getSigner();
                const contractInstance = new ethers.Contract(contractAddress, contractAbi, signer);
                const currentStatus = await contractInstance.getVotingStatus();
                const time = await contractInstance.getRemainingTime();
                console.log(time);
                status.innerHTML = currentStatus == 1 ? "Voting is currently open" : "Voting is finished";
                remainingTime.innerHTML = `Remaining time is ${parseInt(time, 16)} seconds`;
            }
            else {
                var status = document.getElementById("status");
                status.innerHTML = "Please connect metamask first";
            }
        }

        const getAllCandidates = async() => {
            if(WALLET_CONNECTED != 0) {
                var p3 = document.getElementById("p3");
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                const signer = provider.getSigner();
                const contractInstance = new ethers.Contract(contractAddress, contractAbi, signer);
                p3.innerHTML = "Please wait, getting all the candidates from the voting smart contract";
                var candidates = await contractInstance.getAllVotesOfCandiates();
                console.log(candidates);
                var table = document.getElementById("myTable");

                for (let i = 0; i < candidates.length; i++) {
                    var row = table.insertRow();
                    var idCell = row.insertCell();
                    var descCell = row.insertCell();
                    var statusCell = row.insertCell();

                    idCell.innerHTML = i;
                    descCell.innerHTML = candidates[i].name;
                    statusCell.innerHTML = candidates[i].voteCount;
                }

                p3.innerHTML = "The tasks are updated"
            }
            else {
                var p3 = document.getElementById("p3");
                p3.innerHTML = "Please connect metamask first";
            }
        }
    </script>
</body>
</html>
