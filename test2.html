<!DOCTYPE html>
<html>
<head>
    <title>EVS: E-voting System Test</title>
    <style>
        /* Add your styles here */
    </style>
</head>
<body>
    <h1>EVS: E-voting System Test</h1>

    <button onclick="connectToMetamask()">Connect Metamask</button>
    <br>
    <button onclick="getCandidatesAndVotes()">View Candidates & Votes</button>
    <br>
    <div id="candidateList"></div>
    <br>
    <form id="votingForm">
        <input type="number" name="candidateId" placeholder="Enter Candidate ID">
        <button type="button" onclick="castVote()">Vote</button>
    </form>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
    <script>
        let userData = null;
        const contractAbi = [
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_name",
				"type": "string"
			}
		],
		"name": "addNewCandidate",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_candidateIndex",
				"type": "uint256"
			}
		],
		"name": "castVote",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string[]",
				"name": "_initialCandidateNames",
				"type": "string[]"
			},
			{
				"internalType": "uint256",
				"name": "_durationInMinutes",
				"type": "uint256"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "candidates",
		"outputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "voteCount",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getAllCandidates",
		"outputs": [
			{
				"internalType": "string[]",
				"name": "",
				"type": "string[]"
			},
			{
				"internalType": "uint256[]",
				"name": "",
				"type": "uint256[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_candidateIndex",
				"type": "uint256"
			}
		],
		"name": "getCandidateVotes",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getRemainingTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getVotingStatus",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "hasVoted",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "NumberOfCandidates",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "votingEnd",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "votingStart",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

        const contractAddress = "0xd9145CCE52D386f254917e481eB44e9943F39138"; // Replace with your contract address

               async function connectToMetamask() {
            if (window.ethereum) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x1D32' }], // Hexadecimal chain ID for Volta
                    });

                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    userData = { account: accounts[0] };
                    alert("Connected to MetaMask with account: " + userData.account);
                } catch (switchError) {
                    // This error code indicates that the chain has not been added to MetaMask.
                    if (switchError.code === 4902) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [
                                    {
                                        chainId: '0x1D32',
                                        chainName: 'Volta',
                                        rpcUrls: ['https://volta-rpc.energyweb.org'],
                                        blockExplorerUrls: ['http://volta-explorer.energyweb.org'],
                                        nativeCurrency: {
                                            symbol: 'VT',
                                            decimals: 18
                                        },
                                    },
                                ],
                            });
                        } catch (addError) {
                            // handle "add" error
                            console.error("Error adding Volta network:", addError);
                        }
                    }
                    // handle other "switch" errors
                    console.error("Error switching to Volta network:", switchError);
                }
            } else {
                console.error("MetaMask not detected. Please install MetaMask.");
            }
        }

        async function getCandidatesAndVotes() {
            if (!userData) {
                alert("Please connect to MetaMask first.");
                return;
            }

            const web3 = new Web3(window.ethereum);
            const contract = new web3.eth.Contract(contractAbi, contractAddress);

            try {
                const [candidateNames, voteCounts] = await contract.methods.getAllCandidates().call();
                let candidateListHtml = "<ul>";
                for (let i = 0; i < candidateNames.length; i++) {
                    candidateListHtml += `<li>${candidateNames[i]} - Votes: ${voteCounts[i]}</li>`;
                }
                candidateListHtml += "</ul>";
                document.getElementById("candidateList").innerHTML = candidateListHtml;
            } catch (error) {
                console.error("Error fetching candidates:", error);
            }
        }

        async function castVote() {
            if (!userData) {
                alert("Please connect to MetaMask first.");
                return;
            }

            const candidateId = parseInt(document.getElementById("votingForm").elements["candidateId"].value);
            if (isNaN(candidateId)) {
                alert("Invalid candidate ID. Please enter a number.");
                return;
            }

            const web3 = new Web3(window.ethereum);
            const contract = new web3.eth.Contract(contractAbi, contractAddress);

            try {
                await contract.methods.castVote(candidateId).send({ from: userData.account });
                alert("Vote cast successfully!");
                // Optionally refresh the candidate list or update UI
            } catch (error) {
                console.error("Error casting vote:", error);
            }
        }
    </script>
</body>
</html>
